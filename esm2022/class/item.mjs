import { GanttDate } from '../utils/date';
import { BehaviorSubject } from 'rxjs';
import { GanttLinkType } from './link';
const DEFAULT_FILL_INCREMENT_WIDTH = 120;
export var GanttItemType;
(function (GanttItemType) {
    GanttItemType["bar"] = "bar";
    GanttItemType["range"] = "range";
    GanttItemType["custom"] = "custom";
})(GanttItemType || (GanttItemType = {}));
export class GanttItemInternal {
    get refs() {
        return this.refs$.getValue();
    }
    constructor(item, level, view) {
        this.view = view;
        this.refs$ = new BehaviorSubject(null);
        this.origin = item;
        this.id = this.origin.id;
        this.links = (this.origin.links || []).map((link) => {
            if (typeof link === 'string') {
                return {
                    type: GanttLinkType.fs,
                    link
                };
            }
            else {
                return link;
            }
        });
        this.color = this.origin.color;
        this.barStyle = this.origin.barStyle;
        this.linkable = this.origin.linkable === undefined ? true : this.origin.linkable;
        this.draggable = this.origin.draggable === undefined ? true : this.origin.draggable;
        this.itemDraggable = this.origin.itemDraggable;
        this.expandable = this.origin.expandable || (this.origin.children || []).length > 0;
        this.expanded = this.origin.expanded === undefined ? false : this.origin.expanded;
        this.start = item.start ? new GanttDate(item.start) : null;
        this.end = item.end ? new GanttDate(item.end) : null;
        this.level = level;
        this.children = (item.children || []).map((subItem) => {
            return new GanttItemInternal(subItem, level + 1, view);
        });
        this.type = this.origin.type || GanttItemType.bar;
        this.progress = this.origin.progress;
        this.fillDateWhenStartOrEndIsNil(item);
    }
    fillDateWhenStartOrEndIsNil(item) {
        if (this.view) {
            if (item.start && !item.end) {
                this.end = this.view.getDateByXPoint(this.view.getXPointByDate(new GanttDate(item.start)) + DEFAULT_FILL_INCREMENT_WIDTH);
            }
            if (!item.start && item.end) {
                this.start = this.view.getDateByXPoint(this.view.getXPointByDate(new GanttDate(item.end)) - DEFAULT_FILL_INCREMENT_WIDTH);
            }
        }
    }
    updateRefs(refs) {
        this.refs$.next(refs);
    }
    updateDate(start, end) {
        this.start = start;
        this.end = end;
        this.origin.start = this.start.getUnixTime();
        this.origin.end = this.end.getUnixTime();
    }
    updateLevel(level) {
        this.level = level;
    }
    addChildren(items) {
        this.origin.children = items;
        this.children = (items || []).map((subItem) => {
            return new GanttItemInternal(subItem, this.level + 1, this.view);
        });
    }
    setExpand(expanded) {
        this.expanded = expanded;
        this.origin.expanded = expanded;
    }
    addLink(link) {
        this.links = [...this.links, link];
        this.origin.links = this.links;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaXRlbS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3BhY2thZ2VzL2dhbnR0L3NyYy9jbGFzcy9pdGVtLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxTQUFTLEVBQUUsTUFBTSxlQUFlLENBQUM7QUFDMUMsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLE1BQU0sQ0FBQztBQUN2QyxPQUFPLEVBQWEsYUFBYSxFQUFFLE1BQU0sUUFBUSxDQUFDO0FBSWxELE1BQU0sNEJBQTRCLEdBQUcsR0FBRyxDQUFDO0FBUXpDLE1BQU0sQ0FBTixJQUFZLGFBSVg7QUFKRCxXQUFZLGFBQWE7SUFDckIsNEJBQVcsQ0FBQTtJQUNYLGdDQUFlLENBQUE7SUFDZixrQ0FBaUIsQ0FBQTtBQUNyQixDQUFDLEVBSlcsYUFBYSxLQUFiLGFBQWEsUUFJeEI7QUFzQkQsTUFBTSxPQUFPLGlCQUFpQjtJQXFCMUIsSUFBSSxJQUFJO1FBQ0osT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBQ2pDLENBQUM7SUFJRCxZQUFZLElBQWUsRUFBRSxLQUFhLEVBQVUsSUFBZ0I7UUFBaEIsU0FBSSxHQUFKLElBQUksQ0FBWTtRQUZwRSxVQUFLLEdBQUcsSUFBSSxlQUFlLENBQTBDLElBQVcsQ0FBQyxDQUFDO1FBRzlFLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDO1FBQ25CLElBQUksQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUM7UUFDekIsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsS0FBSyxJQUFJLEVBQUUsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ2hELElBQUksT0FBTyxJQUFJLEtBQUssUUFBUSxFQUFFLENBQUM7Z0JBQzNCLE9BQU87b0JBQ0gsSUFBSSxFQUFFLGFBQWEsQ0FBQyxFQUFFO29C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LFFBQVEsQ0FBQztJQUNwQyxDQUFDO0lBRUQsT0FBTyxDQUFDLElBQWU7UUFDbkIsSUFBSSxDQUFDLEtBQUssR0FBRyxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssRUFBRSxJQUFJLENBQUMsQ0FBQztRQUNuQyxJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDO0lBQ25DLENBQUM7Q0FDSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEdhbnR0RGF0ZSB9IGZyb20gJy4uL3V0aWxzL2RhdGUnO1xuaW1wb3J0IHsgQmVoYXZpb3JTdWJqZWN0IH0gZnJvbSAncnhqcyc7XG5pbXBvcnQgeyBHYW50dExpbmssIEdhbnR0TGlua1R5cGUgfSBmcm9tICcuL2xpbmsnO1xuaW1wb3J0IHsgR2FudHRWaWV3VHlwZSB9IGZyb20gJy4vdmlldy10eXBlJztcbmltcG9ydCB7IEdhbnR0VmlldyB9IGZyb20gJy4uL3ZpZXdzL3ZpZXcnO1xuXG5jb25zdCBERUZBVUxUX0ZJTExfSU5DUkVNRU5UX1dJRFRIID0gMTIwO1xuXG5leHBvcnQgaW50ZXJmYWNlIEdhbnR0SXRlbVJlZnMge1xuICAgIHdpZHRoOiBudW1iZXI7XG4gICAgeDogbnVtYmVyO1xuICAgIHk6IG51bWJlcjtcbn1cblxuZXhwb3J0IGVudW0gR2FudHRJdGVtVHlwZSB7XG4gICAgYmFyID0gJ2JhcicsXG4gICAgcmFuZ2UgPSAncmFuZ2UnLFxuICAgIGN1c3RvbSA9ICdjdXN0b20nXG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgR2FudHRJdGVtPFQgPSB1bmtub3duPiB7XG4gICAgaWQ6IHN0cmluZztcbiAgICB0aXRsZTogc3RyaW5nO1xuICAgIHN0YXJ0PzogbnVtYmVyIHwgRGF0ZTtcbiAgICBlbmQ/OiBudW1iZXIgfCBEYXRlO1xuICAgIGdyb3VwX2lkPzogc3RyaW5nO1xuICAgIGxpbmtzPzogKEdhbnR0TGluayB8IHN0cmluZylbXTtcbiAgICBkcmFnZ2FibGU/OiBib29sZWFuO1xuICAgIGl0ZW1EcmFnZ2FibGU/OiBib29sZWFuO1xuICAgIGxpbmthYmxlPzogYm9vbGVhbjtcbiAgICBleHBhbmRhYmxlPzogYm9vbGVhbjtcbiAgICBleHBhbmRlZD86IGJvb2xlYW47XG4gICAgY2hpbGRyZW4/OiBHYW50dEl0ZW1bXTtcbiAgICBjb2xvcj86IHN0cmluZztcbiAgICBiYXJTdHlsZT86IFBhcnRpYWw8Q1NTU3R5bGVEZWNsYXJhdGlvbj47XG4gICAgb3JpZ2luPzogVDtcbiAgICB0eXBlPzogR2FudHRJdGVtVHlwZTtcbiAgICBwcm9ncmVzcz86IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIEdhbnR0SXRlbUludGVybmFsIHtcbiAgICBpZDogc3RyaW5nO1xuICAgIHRpdGxlOiBzdHJpbmc7XG4gICAgc3RhcnQ6IEdhbnR0RGF0ZSB8IG51bGw7XG4gICAgZW5kOiBHYW50dERhdGUgfCBudWxsO1xuICAgIGxpbmtzOiBHYW50dExpbmtbXTtcbiAgICBjb2xvcj86IHN0cmluZztcbiAgICBiYXJTdHlsZT86IFBhcnRpYWw8Q1NTU3R5bGVEZWNsYXJhdGlvbj47XG4gICAgZHJhZ2dhYmxlPzogYm9vbGVhbjtcbiAgICBpdGVtRHJhZ2dhYmxlPzogYm9vbGVhbjtcbiAgICBsaW5rYWJsZT86IGJvb2xlYW47XG4gICAgb3JpZ2luOiBHYW50dEl0ZW07XG4gICAgZXhwYW5kYWJsZT86IGJvb2xlYW47XG4gICAgZXhwYW5kZWQ/OiBib29sZWFuO1xuICAgIGxvYWRpbmc6IGJvb2xlYW47XG4gICAgY2hpbGRyZW46IEdhbnR0SXRlbUludGVybmFsW107XG4gICAgdHlwZT86IEdhbnR0SXRlbVR5cGU7XG4gICAgcHJvZ3Jlc3M/OiBudW1iZXI7XG4gICAgdmlld1R5cGU/OiBHYW50dFZpZXdUeXBlO1xuICAgIGxldmVsOiBudW1iZXI7XG5cbiAgICBnZXQgcmVmcygpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMucmVmcyQuZ2V0VmFsdWUoKTtcbiAgICB9XG5cbiAgICByZWZzJCA9IG5ldyBCZWhhdmlvclN1YmplY3Q8eyB3aWR0aDogbnVtYmVyOyB4OiBudW1iZXI7IHk6IG51bWJlciB9PihudWxsIGFzIGFueSk7XG5cbiAgICBjb25zdHJ1Y3RvcihpdGVtOiBHYW50dEl0ZW0sIGxldmVsOiBudW1iZXIsIHByaXZhdGUgdmlldz86IEdhbnR0Vmlldykge1xuICAgICAgICB0aGlzLm9yaWdpbiA9IGl0ZW07XG4gICAgICAgIHRoaXMuaWQgPSB0aGlzLm9yaWdpbi5pZDtcbiAgICAgICAgdGhpcy5saW5rcyA9ICh0aGlzLm9yaWdpbi5saW5rcyB8fCBbXSkubWFwKChsaW5rKSA9PiB7XG4gICAgICAgICAgICBpZiAodHlwZW9mIGxpbmsgPT09ICdzdHJpbmcnKSB7XG4gICAgICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICAgICAgdHlwZTogR2FudHRMaW5rVHlwZS5mcyxcbiAgICAgICAgICAgICAgICAgICAgbGlua1xuICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICAgIHJldHVybiBsaW5rO1xuICAgICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy5jb2xvciA9IHRoaXMub3JpZ2luLmNvbG9yO1xuICAgICAgICB0aGlzLmJhclN0eWxlID0gdGhpcy5vcmlnaW4uYmFyU3R5bGU7XG4gICAgICAgIHRoaXMubGlua2FibGUgPSB0aGlzLm9yaWdpbi5saW5rYWJsZSA9PT0gdW5kZWZpbmVkID8gdHJ1ZSA6IHRoaXMub3JpZ2luLmxpbmthYmxlO1xuICAgICAgICB0aGlzLmRyYWdnYWJsZSA9IHRoaXMub3JpZ2luLmRyYWdnYWJsZSA9PT0gdW5kZWZpbmVkID8gdHJ1ZSA6IHRoaXMub3JpZ2luLmRyYWdnYWJsZTtcbiAgICAgICAgdGhpcy5pdGVtRHJhZ2dhYmxlID0gdGhpcy5vcmlnaW4uaXRlbURyYWdnYWJsZTtcbiAgICAgICAgdGhpcy5leHBhbmRhYmxlID0gdGhpcy5vcmlnaW4uZXhwYW5kYWJsZSB8fCAodGhpcy5vcmlnaW4uY2hpbGRyZW4gfHwgW10pLmxlbmd0aCA+IDA7XG4gICAgICAgIHRoaXMuZXhwYW5kZWQgPSB0aGlzLm9yaWdpbi5leHBhbmRlZCA9PT0gdW5kZWZpbmVkID8gZmFsc2UgOiB0aGlzLm9yaWdpbi5leHBhbmRlZDtcbiAgICAgICAgdGhpcy5zdGFydCA9IGl0ZW0uc3RhcnQgPyBuZXcgR2FudHREYXRlKGl0ZW0uc3RhcnQpIDogbnVsbDtcbiAgICAgICAgdGhpcy5lbmQgPSBpdGVtLmVuZCA/IG5ldyBHYW50dERhdGUoaXRlbS5lbmQpIDogbnVsbDtcbiAgICAgICAgdGhpcy5sZXZlbCA9IGxldmVsO1xuICAgICAgICB0aGlzLmNoaWxkcmVuID0gKGl0ZW0uY2hpbGRyZW4gfHwgW10pLm1hcCgoc3ViSXRlbSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBHYW50dEl0ZW1JbnRlcm5hbChzdWJJdGVtLCBsZXZlbCArIDEsIHZpZXcpO1xuICAgICAgICB9KTtcbiAgICAgICAgdGhpcy50eXBlID0gdGhpcy5vcmlnaW4udHlwZSB8fCBHYW50dEl0ZW1UeXBlLmJhcjtcbiAgICAgICAgdGhpcy5wcm9ncmVzcyA9IHRoaXMub3JpZ2luLnByb2dyZXNzO1xuICAgICAgICB0aGlzLmZpbGxEYXRlV2hlblN0YXJ0T3JFbmRJc05pbChpdGVtKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGZpbGxEYXRlV2hlblN0YXJ0T3JFbmRJc05pbChpdGVtOiBHYW50dEl0ZW0pIHtcbiAgICAgICAgaWYgKHRoaXMudmlldykge1xuICAgICAgICAgICAgaWYgKGl0ZW0uc3RhcnQgJiYgIWl0ZW0uZW5kKSB7XG4gICAgICAgICAgICAgICAgdGhpcy5lbmQgPSB0aGlzLnZpZXcuZ2V0RGF0ZUJ5WFBvaW50KHRoaXMudmlldy5nZXRYUG9pbnRCeURhdGUobmV3IEdhbnR0RGF0ZShpdGVtLnN0YXJ0KSkgKyBERUZBVUxUX0ZJTExfSU5DUkVNRU5UX1dJRFRIKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIGlmICghaXRlbS5zdGFydCAmJiBpdGVtLmVuZCkge1xuICAgICAgICAgICAgICAgIHRoaXMuc3RhcnQgPSB0aGlzLnZpZXcuZ2V0RGF0ZUJ5WFBvaW50KHRoaXMudmlldy5nZXRYUG9pbnRCeURhdGUobmV3IEdhbnR0RGF0ZShpdGVtLmVuZCkpIC0gREVGQVVMVF9GSUxMX0lOQ1JFTUVOVF9XSURUSCk7XG4gICAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICB1cGRhdGVSZWZzKHJlZnM6IEdhbnR0SXRlbVJlZnMpIHtcbiAgICAgICAgdGhpcy5yZWZzJC5uZXh0KHJlZnMpO1xuICAgIH1cblxuICAgIHVwZGF0ZURhdGUoc3RhcnQ6IEdhbnR0RGF0ZSwgZW5kOiBHYW50dERhdGUpIHtcbiAgICAgICAgdGhpcy5zdGFydCA9IHN0YXJ0O1xuICAgICAgICB0aGlzLmVuZCA9IGVuZDtcbiAgICAgICAgdGhpcy5vcmlnaW4uc3RhcnQgPSB0aGlzLnN0YXJ0LmdldFVuaXhUaW1lKCk7XG4gICAgICAgIHRoaXMub3JpZ2luLmVuZCA9IHRoaXMuZW5kLmdldFVuaXhUaW1lKCk7XG4gICAgfVxuXG4gICAgdXBkYXRlTGV2ZWwobGV2ZWw6IG51bWJlcikge1xuICAgICAgICB0aGlzLmxldmVsID0gbGV2ZWw7XG4gICAgfVxuXG4gICAgYWRkQ2hpbGRyZW4oaXRlbXM6IEdhbnR0SXRlbVtdKSB7XG4gICAgICAgIHRoaXMub3JpZ2luLmNoaWxkcmVuID0gaXRlbXM7XG4gICAgICAgIHRoaXMuY2hpbGRyZW4gPSAoaXRlbXMgfHwgW10pLm1hcCgoc3ViSXRlbSkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBHYW50dEl0ZW1JbnRlcm5hbChzdWJJdGVtLCB0aGlzLmxldmVsICsgMSwgdGhpcy52aWV3KTtcbiAgICAgICAgfSk7XG4gICAgfVxuXG4gICAgc2V0RXhwYW5kKGV4cGFuZGVkOiBib29sZWFuKSB7XG4gICAgICAgIHRoaXMuZXhwYW5kZWQgPSBleHBhbmRlZDtcbiAgICAgICAgdGhpcy5vcmlnaW4uZXhwYW5kZWQgPSBleHBhbmRlZDtcbiAgICB9XG5cbiAgICBhZGRMaW5rKGxpbms6IEdhbnR0TGluaykge1xuICAgICAgICB0aGlzLmxpbmtzID0gWy4uLnRoaXMubGlua3MsIGxpbmtdO1xuICAgICAgICB0aGlzLm9yaWdpbi5saW5rcyA9IHRoaXMubGlua3M7XG4gICAgfVxufVxuIl19